using MySql.Data.MySqlClient;
using System;
using System.Security.Cryptography;
using System.Text;
using System.Text.RegularExpressions;
using System.Windows.Forms;

namespace WinFormsApp2
{
    public partial class RegisterForm : Form
    {
        private readonly DBConnection dbConnection = new DBConnection();

        public RegisterForm()
        {
            InitializeComponent();
        }

        private void btnRegister_Click(object sender, EventArgs e)
        {
            // 1. ดึง "ข้อความที่ผู้ใช้พิมพ์" จาก TextBox แต่ละอัน
            //    ตรวจสอบให้แน่ใจว่าชื่อตรงกับที่คุณตั้งในหน้า Design (เช่น FirstNamebutton, LastNamebutton)
            string firstName = txtFirstName.Text.Trim();
            string lastName = txtLastName.Text.Trim();
            string username = txtUsername.Text.Trim();
            string password = txtPassword.Text;

            // --- ส่วนตรวจสอบข้อมูล (Validation) ---
            if (string.IsNullOrWhiteSpace(firstName) || string.IsNullOrWhiteSpace(lastName) || string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
            {
                MessageBox.Show("กรุณากรอกข้อมูลให้ครบทุกช่อง", "ข้อมูลไม่ครบถ้วน", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            // --- ส่วนตรวจสอบ Username ซ้ำในฐานข้อมูล ---
            using (var conn = new MySqlConnection(dbConnection.connection.ConnectionString))
            {
                try
                {
                    conn.Open();
                    string checkUserQuery = "SELECT COUNT(*) FROM members WHERE username = @username";
                    var cmdCheck = new MySqlCommand(checkUserQuery, conn);
                    cmdCheck.Parameters.AddWithValue("@username", username);

                    long userExists = (long)cmdCheck.ExecuteScalar();
                    if (userExists > 0)
                    {
                        MessageBox.Show("Username นี้มีผู้ใช้งานแล้ว กรุณาใช้ชื่ออื่น", "Username ซ้ำ", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }

                    // --- 3. บันทึกข้อมูลที่ถูกต้องลงฐานข้อมูล ---
                    string insertQuery = @"INSERT INTO members (first_name, last_name, username, password) VALUES (@fname, @lname, @uname, @password);";

                    var cmdInsert = new MySqlCommand(insertQuery, conn);
                    cmdInsert.Parameters.AddWithValue("@fname", firstName);
                    cmdInsert.Parameters.AddWithValue("@lname", lastName);
                    cmdInsert.Parameters.AddWithValue("@uname", username);
                    cmdInsert.Parameters.AddWithValue("@password", password);
                    cmdInsert.ExecuteNonQuery();

                    MessageBox.Show("สมัครสมาชิกสำเร็จ!", "สำเร็จ", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    this.DialogResult = DialogResult.OK;
                    this.Close();
                }
                catch (Exception ex)
                {
                    MessageBox.Show("เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล: " + ex.Message, "ข้อผิดพลาด", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        // ฟังก์ชันสำหรับเข้ารหัสผ่าน (Hashing)
        private string ComputeSha256Hash(string rawData)
        {
            using (SHA256 sha256Hash = SHA256.Create())
            {
                byte[] bytes = sha256Hash.ComputeHash(Encoding.UTF8.GetBytes(rawData));
                StringBuilder builder = new StringBuilder();
                for (int i = 0; i < bytes.Length; i++)
                {
                    builder.Append(bytes[i].ToString("x2"));
                }
                return builder.ToString();
            }
        }

        private void linkBackToLogin_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            this.Close();
        }

        
    }
}
