using System;
using System.Collections.Generic;
using System.Drawing;
using System.Drawing.Printing;
using System.Linq;
using System.Windows.Forms;

namespace WinFormsApp2
{
    public partial class ReceiptForm : Form
    {
        // --- Properties สำหรับรับข้อมูล ---
        private readonly List<OrderItem> _orderItems;
        private readonly string _customerName;
        private readonly string _tableNumber;
        private readonly decimal _subtotal;
        private readonly decimal _vatAmount;
        private readonly decimal _grandTotal;

        // --- Controls ที่เราจะสร้างขึ้นมาเอง ---
        private Panel receiptPanel;
        private Button printButton;
        private Button closeButton;
        private PrintDocument printDocument1;
        private PrintPreviewDialog printPreviewDialog1;

        // --- ตัวแปรสำหรับจัดการการพิมพ์หลายหน้า ---
        private int _lastPrintedItemIndex = 0;

        public ReceiptForm(List<OrderItem> orderItems, string customerName, string tableNumber, decimal subtotal, decimal vatAmount, decimal grandTotal)
        {
            _orderItems = orderItems;
            _customerName = customerName;
            _tableNumber = tableNumber;
            _subtotal = subtotal;
            _vatAmount = vatAmount;
            _grandTotal = grandTotal;
            InitializeCustomComponents();
            this.Load += new EventHandler(ReceiptForm_Load);
        }

        // เมธอดสำหรับสร้าง UI
        private void InitializeCustomComponents()
        {
            this.Text = "ใบเสร็จ";
            this.BackColor = SystemColors.Control;
            this.ClientSize = new Size(450, 650);
            this.StartPosition = FormStartPosition.CenterParent;
            this.FormBorderStyle = FormBorderStyle.Sizable;
            this.MaximizeBox = true;
            this.MinimizeBox = true;

            receiptPanel = new Panel();
            receiptPanel.Location = new Point(12, 12);
            receiptPanel.Size = new Size(this.ClientSize.Width - 24, this.ClientSize.Height - 70);
            receiptPanel.BorderStyle = BorderStyle.FixedSingle;
            receiptPanel.BackColor = Color.White;
            receiptPanel.Anchor = AnchorStyles.Top | AnchorStyles.Left | AnchorStyles.Right | AnchorStyles.Bottom;
            receiptPanel.AutoScroll = true;
            this.Controls.Add(receiptPanel);

            printButton = new Button();
            printButton.Text = "พิมพ์ใบเสร็จ (PDF)";
            printButton.Size = new Size(140, 35);
            printButton.Anchor = AnchorStyles.Bottom | AnchorStyles.Left;
            printButton.Location = new Point(12, this.ClientSize.Height - 47);
            printButton.BackColor = Color.MediumSeaGreen;
            printButton.ForeColor = Color.White;
            printButton.FlatStyle = FlatStyle.Flat;
            printButton.FlatAppearance.BorderSize = 0;
            printButton.Click += new EventHandler(this.printButton_Click);
            this.Controls.Add(printButton);

            closeButton = new Button();
            closeButton.Text = "ปิด";
            closeButton.Size = new Size(80, 35);
            closeButton.Anchor = AnchorStyles.Bottom | AnchorStyles.Left;
            closeButton.Location = new Point(printButton.Right + 10, this.ClientSize.Height - 47);
            closeButton.BackColor = Color.Salmon;
            closeButton.ForeColor = Color.White;
            closeButton.FlatStyle = FlatStyle.Flat;
            closeButton.FlatAppearance.BorderSize = 0;
            closeButton.Click += new EventHandler(this.closeButton_Click);
            this.Controls.Add(closeButton);

            printDocument1 = new PrintDocument();
            printPreviewDialog1 = new PrintPreviewDialog();
            printPreviewDialog1.Document = this.printDocument1;

            printDocument1.PrintPage += new PrintPageEventHandler(this.printDocument1_PrintPage);
            printDocument1.BeginPrint += new PrintEventHandler(this.printDocument1_BeginPrint);
        }

        private void ReceiptForm_Load(object? sender, EventArgs e)
        {
            GenerateReceiptOnPanel();
        }

        private void GenerateReceiptOnPanel()
        {
            receiptPanel.Controls.Clear();
            var fontRegular = new Font("Tahoma", 10, FontStyle.Regular);
            var fontBold = new Font("Tahoma", 10, FontStyle.Bold);
            var fontHeader = new Font("Tahoma", 12, FontStyle.Bold);

            int currentY = 20;
            int leftMargin = 20;
            int rightMargin = receiptPanel.Width - 20;

            // (ส่วนหัวใบเสร็จ)
            AddLabel(receiptPanel, "ใบเสร็จรับเงิน (RECEIPT)", fontHeader, ContentAlignment.MiddleCenter, 0, currentY, receiptPanel.Width);
            currentY += 40;
            AddLabel(receiptPanel, "ร้าน YUMYUM", fontBold, ContentAlignment.MiddleLeft, leftMargin, currentY, 200);
            currentY += 25;
            AddLabel(receiptPanel, $"วันที่: {DateTime.Now:dd/MM/yyyy HH:mm:ss}", fontRegular, ContentAlignment.MiddleLeft, leftMargin, currentY, 300);
            currentY += 25;
            AddLabel(receiptPanel, $"ลูกค้า: {_customerName} (โต๊ะ: {_tableNumber})", fontRegular, ContentAlignment.MiddleLeft, leftMargin, currentY, 300);
            currentY += 30;
            AddLine(receiptPanel, currentY);
            currentY += 10;

            // (หัวตารางรายการ)
            int priceWidth = 90;
            int quantityWidth = 70;
            int priceX = rightMargin - priceWidth;
            int quantityX = priceX - quantityWidth;
            int itemWidth = quantityX - leftMargin;

            AddLabel(receiptPanel, "รายการ", fontBold, ContentAlignment.MiddleLeft, leftMargin, currentY, itemWidth);
            AddLabel(receiptPanel, "จำนวน", fontBold, ContentAlignment.MiddleRight, quantityX, currentY, quantityWidth);
            AddLabel(receiptPanel, "ราคา", fontBold, ContentAlignment.MiddleRight, priceX, currentY, priceWidth);

            currentY += 30;
            // (รายการสินค้า)
            foreach (var item in _orderItems)
            {
                string itemName = $"{item.Name} {item.Flavors}";
                int requiredHeight = CalculateTextHeight(itemName, fontRegular, itemWidth);

                AddLabel(receiptPanel, itemName, fontRegular, ContentAlignment.TopLeft, leftMargin, currentY, itemWidth, requiredHeight);
                AddLabel(receiptPanel, item.Quantity.ToString(), fontRegular, ContentAlignment.TopRight, quantityX, currentY, quantityWidth, requiredHeight);
                AddLabel(receiptPanel, (item.Price * item.Quantity).ToString("N2"), fontRegular, ContentAlignment.TopRight, priceX, currentY, priceWidth, requiredHeight);

                currentY += requiredHeight + 5;
            }
            AddLine(receiptPanel, currentY);
            currentY += 10;

            // (ส่วนท้าย)
            AddLabel(receiptPanel, "ยอดรวม", fontRegular, ContentAlignment.MiddleRight, rightMargin - 200, currentY, 120);
            AddLabel(receiptPanel, _subtotal.ToString("N2"), fontRegular, ContentAlignment.MiddleRight, rightMargin - 90, currentY, 80);
            currentY += 25;
            AddLabel(receiptPanel, "ภาษี 7%", fontRegular, ContentAlignment.MiddleRight, rightMargin - 200, currentY, 120);
            AddLabel(receiptPanel, _vatAmount.ToString("N2"), fontRegular, ContentAlignment.MiddleRight, rightMargin - 90, currentY, 80);
            currentY += 25;
            AddLabel(receiptPanel, "ยอดรวมสุทธิ", fontBold, ContentAlignment.MiddleRight, rightMargin - 200, currentY, 120);
            AddLabel(receiptPanel, _grandTotal.ToString("N2"), fontBold, ContentAlignment.MiddleRight, rightMargin - 90, currentY, 80);

            currentY += 40;
            AddLabel(receiptPanel, "ขอบคุณที่ใช้บริการ", fontRegular, ContentAlignment.MiddleCenter, 0, currentY, receiptPanel.Width);
        }

        private void printButton_Click(object? sender, EventArgs e)
        {
            try
            {
                printPreviewDialog1.WindowState = FormWindowState.Maximized;
                printPreviewDialog1.ShowDialog();
            }
            catch (Exception ex)
            {
                MessageBox.Show("เกิดข้อผิดพลาดในการเปิด Print Preview:\n" + ex.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void printDocument1_BeginPrint(object? sender, PrintEventArgs e)
        {
            // รีเซ็ต index ทุกครั้งที่เริ่มกระบวนการพิมพ์ใหม่
            _lastPrintedItemIndex = 0;
        }

        private void printDocument1_PrintPage(object? sender, PrintPageEventArgs e)
        {
            Graphics g = e.Graphics;
            if (g == null) return;

            var fontRegular = new Font("Tahoma", 10, FontStyle.Regular);
            var fontBold = new Font("Tahoma", 10, FontStyle.Bold);
            var fontHeader = new Font("Tahoma", 12, FontStyle.Bold);

            using (SolidBrush blackBrush = new SolidBrush(Color.Black))
            using (Pen blackPen = new Pen(Color.Black, 1))
            {
                float currentY = e.MarginBounds.Top;
                float leftMargin = e.MarginBounds.Left;
                float rightMargin = e.MarginBounds.Right;
                float pageCenter = e.MarginBounds.Left + e.MarginBounds.Width / 2f;
                StringFormat formatCenter = new StringFormat { Alignment = StringAlignment.Center };
                StringFormat formatLeft = new StringFormat { Alignment = StringAlignment.Near };
                StringFormat formatRight = new StringFormat { Alignment = StringAlignment.Far };

                // --- 1. วาดส่วนหัวของเอกสาร (วาดทุกหน้า) ---
                g.DrawString("ใบเสร็จรับเงิน (RECEIPT)", fontHeader, blackBrush, pageCenter, currentY, formatCenter);
                currentY += 40;
                g.DrawString("ร้าน YUMYUM", fontBold, blackBrush, leftMargin, currentY, formatLeft);
                currentY += 25;
                g.DrawString($"วันที่: {DateTime.Now:dd/MM/yyyy HH:mm:ss}", fontRegular, blackBrush, leftMargin, currentY, formatLeft);
                currentY += 25;
                g.DrawString($"ลูกค้า: {_customerName} (โต๊ะ: {_tableNumber})", fontRegular, blackBrush, leftMargin, currentY, formatLeft);
                currentY += 30;
                g.DrawLine(blackPen, leftMargin, currentY, rightMargin, currentY);
                currentY += 10;

                // --- 2. วาดหัวตารางรายการสินค้า (วาดทุกหน้า) ---
                float priceX = rightMargin;
                float quantityX = rightMargin - 100;
                g.DrawString("รายการ", fontBold, blackBrush, leftMargin, currentY, formatLeft);
                g.DrawString("จำนวน", fontBold, blackBrush, quantityX, currentY, formatRight);
                g.DrawString("ราคา", fontBold, blackBrush, priceX, currentY, formatRight);
                currentY += 30;

                // --- 3. วนลูปวาดรายการสินค้า ---
                while (_lastPrintedItemIndex < _orderItems.Count)
                {
                    OrderItem item = _orderItems[_lastPrintedItemIndex];
                    string itemName = $"{item.Name} {item.Flavors}";
                    string itemQuantity = item.Quantity.ToString();
                    string itemTotalPrice = (item.Price * item.Quantity).ToString("N2");

                    // คำนวณความสูงของข้อความชื่อสินค้าที่อาจจะยาวหลายบรรทัด
                    float itemWidth = e.MarginBounds.Width - 200;
                    SizeF itemNameSize = g.MeasureString(itemName, fontRegular, (int)itemWidth);
                    float requiredHeight = itemNameSize.Height + 5;

                    // ตรวจสอบว่ามีพื้นที่พอสำหรับรายการถัดไปหรือไม่
                    // โดยเผื่อพื้นที่สำหรับส่วนท้ายของบิลไว้ด้วย (ประมาณ 150 pixels)
                    if (currentY + requiredHeight > e.MarginBounds.Bottom - 150)
                    {
                        e.HasMorePages = true;
                        return;
                    }

                    // ถ้ามีพื้นที่พอ ให้วาดรายการ
                    RectangleF itemRect = new RectangleF(leftMargin, currentY, itemWidth, itemNameSize.Height);
                    g.DrawString(itemName, fontRegular, blackBrush, itemRect, formatLeft);
                    g.DrawString(itemQuantity, fontRegular, blackBrush, quantityX, currentY, formatRight);
                    g.DrawString(itemTotalPrice, fontRegular, blackBrush, priceX, currentY, formatRight);

                    currentY += requiredHeight;
                    _lastPrintedItemIndex++;
                }

                // --- 4. วาดส่วนท้ายของบิล (จะถูกวาดเฉพาะหน้าสุดท้าย) ---
                g.DrawLine(blackPen, leftMargin, currentY, rightMargin, currentY);
                currentY += 10;

                g.DrawString("ยอดรวม", fontRegular, blackBrush, rightMargin - 120, currentY, formatRight);
                g.DrawString(_subtotal.ToString("N2"), fontRegular, blackBrush, rightMargin, currentY, formatRight);
                currentY += 25;

                g.DrawString("ภาษี 7%", fontRegular, blackBrush, rightMargin - 120, currentY, formatRight);
                g.DrawString(_vatAmount.ToString("N2"), fontRegular, blackBrush, rightMargin, currentY, formatRight);
                currentY += 25;

                g.DrawString("ยอดรวมสุทธิ", fontBold, blackBrush, rightMargin - 120, currentY, formatRight);
                g.DrawString(_grandTotal.ToString("N2"), fontBold, blackBrush, rightMargin, currentY, formatRight);

                currentY += 40;
                g.DrawString("ขอบคุณที่ใช้บริการ", fontRegular, blackBrush, pageCenter, currentY, formatCenter);

                // --- 5. สิ้นสุดการพิมพ์ ---
                e.HasMorePages = false;
                _lastPrintedItemIndex = 0;
            }
        }

        // ส่วนประกอบในบิล
        private void AddLabel(Control parent, string text, Font font, ContentAlignment align, int x, int y, int width, int height = 25)
        {
            var label = new Label
            {
                Text = text,
                Font = font,
                TextAlign = align,
                Location = new Point(x, y),
                Size = new Size(width, height)
            };
            parent.Controls.Add(label);
        }
        private void AddLine(Control parent, int y)
        {
            var line = new Label
            {
                Text = "",
                BorderStyle = BorderStyle.Fixed3D,
                Height = 2,
                Location = new Point(10, y),
                Width = parent.Width - 20
            };
            parent.Controls.Add(line);
        }
        private int CalculateTextHeight(string text, Font font, int width)
        {
            using (var g = this.CreateGraphics())
            {
                var size = g.MeasureString(text, font, width);
                return (int)Math.Ceiling(size.Height) + 5;
            }
        }
        private void closeButton_Click(object? sender, EventArgs e)
        {
            this.Close();
        }
    }
}
